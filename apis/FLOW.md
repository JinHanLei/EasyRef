# EasyRef 前后端操作逻辑流程

本文档详细描述了 EasyRef 系统的主要操作流程，包括用户认证、论文搜索、知识库管理和智能分类等功能的前后端交互逻辑。

## 1. 用户认证流程 (auth_api.py)

### 1.1 用户注册
- 前端：用户填写注册表单（邮箱、密码等信息）
- 前端 → 后端：发送 POST 请求到 `/api/auth/signup` 接口
- 后端：验证信息合法性，调用 Supabase Auth API 创建用户
- 后端 → 前端：返回注册结果（已发送邮件/失败）
- 前端：根据结果提示用户注册成功或显示错误信息

### 1.2 用户登录
- 前端：用户填写登录表单（邮箱、密码）
- 前端 → 后端：发送 POST 请求到 `/auth/login` 接口
- 后端：调用 Supabase Auth API 验证用户凭证
- 后端 → 前端：返回认证令牌和用户信息（成功）或错误信息（失败）
- 前端：保存认证信息，跳转到主界面

### 1.3 用户登出
- 前端：用户点击登出按钮
- 前端 → 后端：发送 POST 请求到 `/auth/logout` 接口
- 后端：清除会话信息
- 后端 → 前端：返回操作结果
- 前端：清除本地认证信息，跳转到登录页面

### 1.4 获取用户信息
- 前端：在需要显示用户信息或验证登录状态时
- 前端 → 后端：发送 GET 请求到 `/auth/user` 接口
- 后端：调用 Supabase Auth API 获取当前用户信息
- 后端 → 前端：返回当前用户的基本信息（ID、邮箱、创建时间等）
- 前端：根据返回信息更新界面显示或执行其他操作

### 1.5 删除用户账户
- 前端：用户在账户设置页面点击"删除账户"按钮，确认操作
- 前端 → 后端：发送 DELETE 请求到 `/auth/delete` 接口
- 后端：验证用户身份，调用 Supabase Admin API 删除当前用户账户
- 后端 → 前端：返回操作结果
- 前端：根据结果提示用户，如成功则跳转到登录页面

## 2. 论文搜索流程 (crawler_api.py)

### 2.1 发起搜索
- 前端：用户输入关键词和年份信息，点击"查找"按钮
- 前端 → 后端：发送 POST 请求到 `/api/crawler/scholar` 接口，携带关键词和年份参数
- 后端：调用 [get_google_scholar](../crawler/get_scholar.py) 模块开始爬取 Google Scholar

### 2.2 实时反馈爬取进度
- 后端：在爬取过程中，每获取到一篇论文就通过 Server-Sent Events (SSE) 向前端发送进度更新
- 后端 → 前端：实时推送已爬取论文数量和论文基本信息
- 前端：显示加载动画和实时更新的爬取进度

### 2.3 获取论文详细信息
- 后端：对每篇爬取到的论文：
  1. 调用数据库查询接口，尝试从 `papers` 表中获取已存在的摘要（abstract）
  2. 如果数据库中没有摘要，则调用 [get_abstract](../crawler/get_abstract.py) 爬虫获取摘要并存入数据库
  3. 尝试获取论文 PDF 文件
- 后端：将论文数据临时存储在内存中，避免创建临时表
- 后端 → 前端：返回分页的论文列表信息

### 2.4 展示搜索结果
- 前端：实现分页展示，每页显示固定数量的论文（例如20条）
- 前端：展示论文列表，每行显示论文基本信息（标题、作者、年份、出版信息等）
- 前端：对于摘要和 PDF 列，如果未能获取到，则显示"编辑"和"上传"按钮供用户操作
- 前端：提供分页控件，支持用户切换页面

### 2.5 临时搜索结果处理
为了避免为每次搜索创建临时表的高成本，系统采用以下策略：

1. **内存存储**：搜索结果临时存储在后端服务器内存中，设置合理的过期时间（如1小时）
2. **按需分页**：仅在用户请求特定页面时才从完整结果中提取对应数据返回
3. **会话关联**：通过用户会话ID关联搜索结果，确保数据隔离
4. **自动清理**：设置定时任务清理过期的搜索结果，释放内存资源

## 3. 论文智能分类流程 (llm_api.py)

### 3.1 发起分类
- 前端：用户选择需要分类的论文（可全选当前页或跨页选择），点击"智能分类"按钮
- 前端：弹出对话框，用户输入分类提示词（包括类别名称和描述）
- 前端 → 后端：发送 POST 请求到 `/classify` 接口，携带选中论文ID列表和分类提示词

### 3.2 执行分类
- 后端：调用大模型服务，根据用户提供的提示词对选中论文进行分类
- 后端：处理分类结果，为每篇论文添加分类标签并存储到 [paper_classifications](../db/init_tables.sql) 表
- 后端 → 前端：返回分类结果

### 3.3 展示分类结果
- 前端：在论文列表中新增"分类"列，显示每篇论文的分类结果
- 前端：提供按分类筛选功能
- 前端：提供"全选并加入知识库"功能

## 4. 知识库管理流程 (kb_api.py)

### 4.1 创建知识库
有两种方式创建知识库：

1. **直接创建**：
   - 前端：用户在知识库界面点击"新建知识库"
   - 前端：弹出创建表单，用户填写知识库名称等信息
   - 前端 → 后端：发送 POST 请求到 `/knowledge-bases` 接口
   - 后端：在 [knowledge_bases](../db/init_tables.sql) 表中创建新记录
   - 后端 → 前端：返回创建结果

2. **基于搜索/分类结果创建**：
   - 前端：用户完成搜索和分类后，选择相关论文
   - 前端：点击"创建知识库"，可选择将分类结果作为不同知识库
   - 前端 → 后端：发送 POST 请求到 `/knowledge-bases/batch` 接口
   - 后端：批量创建知识库及关联论文，存储到 [knowledge_base_papers](../db/init_tables.sql) 表

### 4.2 知识库展示
- 前端：左侧边栏显示用户所有知识库列表
- 前端：点击知识库名称进入详情页面，展示该知识库中的论文列表（同样采用分页展示）

### 4.3 知识库操作
- 前端：支持对知识库内论文进行筛选、删除等操作
- 前端：支持拖拽上传论文或 bib 文件到知识库

## 5. 智能问答与总结流程 (llm_api.py)

### 5.1 单篇论文问答
- 前端：用户在知识库中选择一篇论文，点击"提问"按钮
- 前端：显示问答界面，用户输入问题
- 前端 → 后端：发送 POST 请求到 `/qa/paper` 接口，携带论文ID和问题
- 后端：使用 RAG 技术检索论文内容，结合大模型生成回答
- 后端 → 前端：返回回答结果

### 5.2 批量论文总结
- 前端：用户在知识库中选择多篇论文，点击"总结"按钮
- 前端 → 后端：发送 POST 请求到 `/summarize` 接口，携带选中论文ID列表
- 后端：使用大模型对选中论文进行批量总结
- 后端 → 前端：返回总结结果

## 6. 分页与性能优化 (crawler_api.py)

### 6.1 分页策略
- 前端采用分页展示，每页显示固定数量的论文（如20条）
- 用户可以通过分页控件浏览不同页面的数据
- 支持按需加载，当用户滚动到页面底部时自动加载下一页（无限滚动）

### 6.2 数据库优化
- 利用数据库索引优化查询性能，如 [idx_papers_title](../db/init_tables.sql)、[idx_papers_pub_year](../db/init_tables.sql) 等
- 对于大量数据查询，使用 LIMIT 和 OFFSET 进行分页
- 使用数据库连接池提高数据库访问效率

### 6.3 缓存策略
- 对于搜索结果，临时存储在服务器内存中，避免重复爬取
- 对于已获取的论文摘要等信息，存储在数据库中避免重复爬取
- 设置合理的缓存过期时间，平衡内存使用和用户体验

## 数据库表设计说明

系统已经设计了完善的数据库表结构，支持论文管理、知识库、分类、对话等核心功能：

- [papers](../db/init_tables.sql) 表：存储论文的核心元数据
- [paper_files](../db/init_tables.sql) 表：管理用户上传或下载的PDF文件
- [paper_classifications](../db/init_tables.sql) 表：存储AI生成的分类结果
- [knowledge_bases](../db/init_tables.sql) 表：管理用户创建的知识库
- [knowledge_base_papers](../db/init_tables.sql) 表：维护知识库与论文的关联关系
- [conversations](../db/init_tables.sql) 和 [conversation_messages](../db/init_tables.sql) 表：支持智能问答功能
- [search_history](../db/init_tables.sql) 表：记录用户搜索历史
- [paper_embeddings](../db/init_tables.sql) 表：存储论文的向量表示，支持语义搜索

## 注意事项

1. 所有涉及用户数据的操作都需要进行身份验证
2. 前端应处理各种异常情况，如网络错误、服务器错误等
3. 对于耗时操作，前端应提供加载状态提示
4. 用户上传的文件需要进行类型和大小验证
5. 系统应记录用户操作日志，便于问题追踪和分析
6. 大量数据传输时应采用分页策略，避免一次性加载过多数据
7. 数据库查询应充分利用索引优化性能
8. 临时搜索结果应合理使用内存缓存，避免创建临时表